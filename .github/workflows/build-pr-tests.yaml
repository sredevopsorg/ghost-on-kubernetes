name: Build tests

on:
  workflow_dispatch:
  pull_request:
    types: [opened, reopened, edited]
    branches:
      - main
    paths:
      - Dockerfile
      - Dockerfile-dev
      - entrypoint.js

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit
      
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          # Fetch full history for git diff to work correctly on PRs
          fetch-depth: 0 
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1
        with:
          driver-opts: |
            network=host

      - name: Gets GHOST_VERSION
        continue-on-error: false
        id: versions
        run: |
          echo "GHOST_VERSION=$(curl -s https://api.github.com/repos/tryghost/ghost/releases/latest | jq '.name' | sed 's/\"//g')" >> $GITHUB_OUTPUT
          
      - name: Show GHOST_VERSION
        continue-on-error: true
        run: echo ${{ steps.versions.outputs.GHOST_VERSION }}

      - name: üîç Check for Dockerfile Changes using Git Diff
        id: check_files
        # Only run this file-checking logic for Pull Request events
        if: github.event_name == 'pull_request' 
        run: |
          # Get the comparison commit for the PR (base vs head)
          BASE_REF=${{ github.event.pull_request.base.sha }}
          HEAD_REF=${{ github.sha }}

          echo "Comparing $BASE_REF with $HEAD_REF"

          # Check if Dockerfile was modified
          if git diff --name-only $BASE_REF $HEAD_REF | grep -q "^Dockerfile$"; then
            echo "Dockerfile was modified."
            echo "DOCKERFILE_MODIFIED=true" >> $GITHUB_OUTPUT
          else
            echo "Dockerfile was NOT modified."
          fi

          # Check if Dockerfile-dev was modified
          if git diff --name-only $BASE_REF $HEAD_REF | grep -q "^Dockerfile-dev$"; then
            echo "Dockerfile-dev was modified."
            echo "DOCKERFILE_DEV_MODIFIED=true" >> $GITHUB_OUTPUT
          else
            echo "Dockerfile-dev was NOT modified."
          fi

      # --- Conditional Build Stages ---

      - name: ‚öôÔ∏è Build Production Image (if Dockerfile changed)
        # Use the bash output for conditional check
        if: github.event_name == 'workflow_dispatch' || steps.check_files.outputs.DOCKERFILE_MODIFIED == 'true'
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        id: build-test
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          cache-from: type=gha,mode=max
          cache-to: type=gha,mode=max
          push: false
          build-args: GHOST_VERSION=${{ steps.versions.outputs.GHOST_VERSION }}

      - name: üß™ Build Development Image (if Dockerfile-dev changed)
        # Use the bash output for conditional check
        if: github.event_name == 'workflow_dispatch' || steps.check_files.outputs.DOCKERFILE_DEV_MODIFIED == 'true'
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        id: build-dev-test
        with:
          context: .
          file: ./Dockerfile-dev
          platforms: linux/amd64
          cache-from: type=gha,mode=max
          cache-to: type=gha,mode=max
          push: false
          build-args: GHOST_VERSION=${{ steps.versions.outputs.GHOST_VERSION }}
